<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noble Chain - Reset Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="supabase-client.js" type="module"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-white text-black min-h-screen flex items-center justify-center px-4">

<div id="resetContainer" class="max-w-sm w-full">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold mb-2">Reset Your Password</h1>
        <p class="text-gray-600">Enter your new password below</p>
    </div>

    <form id="resetPasswordForm" class="space-y-4">
        <input type="password" id="newPassword" placeholder="New Password" class="w-full p-4 border rounded-2xl" required>
        <input type="password" id="confirmPassword" placeholder="Confirm New Password" class="w-full p-4 border rounded-2xl" required>
        <button type="submit" class="w-full bg-black text-white py-4 rounded-2xl font-semibold text-lg">Update Password</button>
    </form>

    <div class="mt-6 text-center">
        <a href="index.html" class="text-gray-600 underline">Back to Login</a>
    </div>
</div>

<script type="module">
    import { supabase } from './supabase-client.js';

    // Check if we have a session with password recovery
    async function handlePasswordReset() {
        try {
            const { data, error } = await supabase.auth.getSession();

            if (error) {
                console.error('Session error:', error);
                // For demo purposes, show a helpful message
                document.getElementById('resetContainer').innerHTML = `
                    <div class="text-center">
                        <h1 class="text-3xl font-bold mb-4">Password Reset</h1>
                        <p class="text-gray-600 mb-6">This is a demo application. Password reset functionality requires email configuration in Supabase.</p>
                        <p class="text-sm text-gray-500 mb-6">In a production app, you would receive an email with a reset link that brings you here to set a new password.</p>
                        <a href="index.html" class="bg-black text-white py-3 px-6 rounded-xl font-semibold">Back to Login</a>
                    </div>
                `;
                return;
            }

            if (data.session) {
                console.log('Valid session found for password reset');
                // Show the password reset form
            } else {
                // No valid session, show demo message
                document.getElementById('resetContainer').innerHTML = `
                    <div class="text-center">
                        <h1 class="text-3xl font-bold mb-4">Invalid Reset Link</h1>
                        <p class="text-gray-600 mb-6">This reset link is invalid or has expired.</p>
                        <p class="text-sm text-gray-500 mb-6">Please request a new password reset from the login page.</p>
                        <a href="index.html" class="bg-black text-white py-3 px-6 rounded-xl font-semibold">Back to Login</a>
                    </div>
                `;
            }
        } catch (err) {
            console.error('Error checking session:', err);
            // Show demo message for any errors
            document.getElementById('resetContainer').innerHTML = `
                <div class="text-center">
                    <h1 class="text-3xl font-bold mb-4">Password Reset</h1>
                    <p class="text-gray-600 mb-6">This is a demo application. Password reset functionality requires email configuration in Supabase.</p>
                    <p class="text-sm text-gray-500 mb-6">In a production app, you would be able to reset your password here.</p>
                    <a href="index.html" class="bg-black text-white py-3 px-6 rounded-xl font-semibold">Back to Login</a>
                </div>
            `;
        }
    }

    // Handle password reset form submission (only shown if session is valid)
    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('Passwords do not match!');
            return;
        }

        if (newPassword.length < 6) {
            alert('Password must be at least 6 characters long.');
            return;
        }

        try {
            const { data, error } = await supabase.auth.updateUser({
                password: newPassword
            });

            if (error) {
                alert('Password update failed: ' + error.message);
                return;
            }

            alert('Password updated successfully! You can now log in with your new password.');
            window.location.href = 'index.html';
        } catch (err) {
            console.error('Password update error:', err);
            alert('Password update failed: ' + err.message);
        }
    });

    // Check for password reset on page load
    handlePasswordReset();
</script>

</body>
</html>