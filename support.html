<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noble Chain - Support Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .message-user { background: #3b82f6; color: #ffffff; }
        .message-ai { background: #f3f4f6; color: #000000; }
        .message-admin { background: #10b981; color: #ffffff; }
        .typing-indicator { animation: pulse 1.5s infinite; }
        .chat-container { height: calc(100vh - 140px); }
        .message-input { transition: all 0.2s ease; }
        .message-input:focus { border-color: #000000; box-shadow: 0 0 0 3px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-white text-black min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b border-gray-100 px-4 py-3 sticky top-0 z-40">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <button onclick="goBack()" class="p-2 -ml-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <h1 class="text-xl font-semibold">Noble Chain Support</h1>
                </div>
            </div>
            <button onclick="clearChat()" class="text-gray-400 p-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Chat Messages -->
    <main class="max-w-md mx-auto px-4 chat-container">
        <div id="chatMessages" class="space-y-4 py-4">
            <!-- Messages will be populated by JavaScript -->
        </div>
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" class="hidden">
            <div class="flex items-center space-x-2 text-gray-500 text-sm">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
                </div>
                <span id="typingText">AI is typing...</span>
            </div>
        </div>
    </main>

    <!-- Message Input -->
    <div class="fixed bottom-20 left-0 right-0 bg-white border-t border-gray-100 px-4 py-3">
        <div class="max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <input type="text" id="messageInput" 
                       class="flex-1 p-3 border border-gray-200 rounded-xl message-input" 
                       placeholder="Type your message...">
                <button id="sendButton" onclick="sendMessage()" 
                        class="bg-black text-white p-3 rounded-xl hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-4 py-2 z-50">
        <div class="flex justify-around max-w-md mx-auto">
            <a href="dashboard.html" class="flex flex-col items-center py-2 text-gray-400">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <span class="text-xs font-medium">Home</span>
            </a>
            <a href="dashboard.html#buy" class="flex flex-col items-center py-2 text-gray-400">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-xs font-medium">Buy/Sell</span>
            </a>
            <a href="swap.html" class="flex flex-col items-center py-2 text-gray-400">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-xs font-medium">Swap</span>
            </a>
            <a href="transactions.html" class="flex flex-col items-center py-2 text-gray-400">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-xs font-medium">Transactions</span>
            </a>
            <a href="wallet.html" class="flex flex-col items-center py-2 text-gray-400">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zM18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"></path>
                </svg>
                <span class="text-xs font-medium">Wallet</span>
            </a>
        </div>
    </nav>

    <script src="main.js"></script>
    <script>
        class SupportChat {
            constructor() {
                this.isAdminLoggedIn = localStorage.getItem('noblechain_admin_session') !== null;
                this.init();
            }

            init() {
                if (!window.nobleChain.currentUser) {
                    window.location.href = 'index.html';
                    return;
                }

                this.renderMessages();
                this.bindEvents();
                
                // Check for admin session updates
                setInterval(() => {
                    const wasAdmin = this.isAdminLoggedIn;
                    this.isAdminLoggedIn = localStorage.getItem('noblechain_admin_session') !== null;
                    
                    if (wasAdmin !== this.isAdminLoggedIn) {
                        this.updateTypingIndicator();
                    }
                }, 2000);
            }

            renderMessages() {
                const container = document.getElementById('chatMessages');
                const messages = window.nobleChain.getSupportChats(window.nobleChain.currentUser.id);
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                            </svg>
                            <p class="text-lg font-medium mb-2">Welcome to Noble Chain Support</p>
                            <p class="text-sm">Ask me anything about your wallet, transactions, or account security.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = messages.map(message => {
                    const isUser = message.senderType === 'user';
                    const messageClass = `message-${message.senderType}`;
                    const alignmentClass = isUser ? 'ml-auto' : 'mr-auto';
                    const senderLabel = message.senderType === 'ai' ? 'AI Assistant' : 
                                       message.senderType === 'admin' ? 'Support Agent' : 'You';
                    
                    return `
                        <div class="mb-4 ${isUser ? 'text-right' : 'text-left'}">
                            <div class="inline-block max-w-xs">
                                <div class="text-xs text-gray-500 mb-1 ${isUser ? 'text-right' : 'text-left'}">
                                    ${senderLabel}
                                </div>
                                <div class="inline-block px-4 py-3 rounded-2xl ${messageClass} ${alignmentClass}">
                                    ${message.message}
                                </div>
                                <div class="text-xs text-gray-400 mt-1 ${isUser ? 'text-right' : 'text-left'}">
                                    ${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Add user message
                window.nobleChain.sendSupportMessage(message, false, 'user');
                input.value = '';
                
                // Re-render messages
                this.renderMessages();
                
                // Check if admin is logged in
                if (this.isAdminLoggedIn) {
                    // Admin is logged in, don't auto-respond
                    return;
                }
                
                // Show typing indicator and simulate AI response
                this.showTypingIndicator();
                
                setTimeout(() => {
                    this.simulateAIResponse(message);
                }, 1000 + Math.random() * 1000);
            }

            simulateAIResponse(userMessage) {
                const aiResponse = window.nobleChain.generateAIResponse(userMessage);
                
                this.hideTypingIndicator();
                
                setTimeout(() => {
                    window.nobleChain.sendSupportMessage(aiResponse, false, 'ai');
                    this.renderMessages();
                }, 500);
            }

            showTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                const text = document.getElementById('typingText');
                
                text.textContent = this.isAdminLoggedIn ? 'Support agent is typing...' : 'AI is typing...';
                indicator.classList.remove('hidden');
            }

            hideTypingIndicator() {
                document.getElementById('typingIndicator').classList.add('hidden');
            }

            updateTypingIndicator() {
                const text = document.getElementById('typingText');
                text.textContent = this.isAdminLoggedIn ? 'Support agent is typing...' : 'AI is typing...';
            }

            clearChat() {
                if (confirm('Are you sure you want to clear this chat? This cannot be undone.')) {
                    // Filter out current user's messages
                    window.nobleChain.supportChats = window.nobleChain.supportChats.filter(
                        chat => chat.userId !== window.nobleChain.currentUser.id
                    );
                    window.nobleChain.saveSupportChats();
                    this.renderMessages();
                }
            }

            bindEvents() {
                // Send message on Enter key
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                // Listen for support chat updates
                document.addEventListener('noblechain:support_update', () => {
                    this.renderMessages();
                });
            }
        }

        // Global functions
        function sendMessage() {
            supportChat.sendMessage();
        }

        function clearChat() {
            supportChat.clearChat();
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        // Initialize Support Chat
        let supportChat;
        document.addEventListener('DOMContentLoaded', () => {
            supportChat = new SupportChat();
        });
    </script>
</body>
</html>